name: _Release

on:
  workflow_call:
    inputs:
      tag:
        description: Create git tag from podspec version
        required: true
        type: boolean
      release:
        description: Create or update GitHub Release for the tag
        required: true
        type: boolean
      carthage:
        description: Build and upload Carthage archive to the release
        required: true
        type: boolean
      pods:
        description: Work with CocoaPods (push if no cleanup, lint if cleanup)
        required: true
        type: boolean
      cleanup:
        description: Cleanup created artifacts (release/tag)
        required: true
        type: boolean
      release_draft:
        description: Create/keep release as draft
        required: true
        type: boolean
      release_tag:
        description: Release tag to work with (usually from guard)
        required: true
        type: string
      is_full_release:
        description: Computed in guard; whether this is a full release
        required: true
        type: boolean
      release_existed:
        description: Computed in guard; whether release existed before this run
        required: true
        type: boolean
    secrets:
      COCOAPODS_TRUNK_TOKEN:
        required: false

jobs:
  release:
    name: Release
    runs-on: ${{ vars.MACOS_RUNNER }}
    concurrency: release-${{ inputs.release_tag }}
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RELEASE_TAG: ${{ inputs.release_tag }}
    steps:
      - name: Plan
        shell: bash
        run: |
          echo "Selected steps: tag=${{ inputs.tag }}, release=${{ inputs.release }}, carthage=${{ inputs.carthage }}, pods=${{ inputs.pods }}, cleanup=${{ inputs.cleanup }}"
          echo "is_full_release=${{ inputs.is_full_release }}; release_tag=${{ inputs.release_tag }}; release_draft=${{ inputs.release_draft }}; release_existed=${{ inputs.release_existed }}"

      - name: Guard branch for full release tag
        if: ${{ inputs.tag == true && inputs.is_full_release == true }}
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_name }}" != "master" ]; then
            echo "::error::Full release (tag) allowed only from 'master' (got '${{ github.ref_name }}')"; exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ vars.XCODE_VERSION }}

      - name: Install dependencies
        run: |
          brew install xcbeautify
          gem install cocoapods --no-document
          brew install gh
          if [ "${{ inputs.carthage }}" = "true" ]; then
            brew install carthage
          fi
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Create tag
        if: ${{ inputs.tag == true }}
        id: create_tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG"
          git push origin "$RELEASE_TAG"
          echo "created=true" >> "$GITHUB_OUTPUT"

      - name: Create or update GitHub Release
        if: ${{ inputs.release == true }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          draft: ${{ inputs.release_draft }}

      - name: Build Carthage archives
        if: ${{ inputs.carthage == true }}
        run: |
          set -o pipefail
          # Build XCFrameworks to avoid lipo conflicts on arm64 simulator/device
          carthage build --no-skip-current --platform iOS,macOS --use-xcframeworks --verbose 2>&1 | xcbeautify --renderer github-actions
          # Package the built XCFramework (fallback to legacy archive if needed)
          PRODUCT_NAME="${{ vars.PRODUCT_NAME }}"
          XCFRAMEWORK_PATH=""
          if [ -d "Carthage/Build/${PRODUCT_NAME}.xcframework" ]; then
            XCFRAMEWORK_PATH="Carthage/Build/${PRODUCT_NAME}.xcframework"
          else
            XCFRAMEWORK_PATH=$(find Carthage/Build -maxdepth 2 -type d -name "${PRODUCT_NAME}.xcframework" | head -n 1 || true)
          fi
          if [ -n "$XCFRAMEWORK_PATH" ] && [ -d "$XCFRAMEWORK_PATH" ]; then
            echo "Found XCFramework at: $XCFRAMEWORK_PATH"
            ARCHIVE_NAME="${PRODUCT_NAME}.xcframework.zip"
            ditto -c -k --sequesterRsrc --keepParent "$XCFRAMEWORK_PATH" "$ARCHIVE_NAME"
            ls -lh "$ARCHIVE_NAME"
          else
            echo "No XCFramework found, falling back to Carthage .framework archive"
            carthage archive "$PRODUCT_NAME"
          fi

      - name: Upload Carthage archive asset
        if: ${{ inputs.carthage == true }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "$RELEASE_TAG" "${{ vars.PRODUCT_NAME }}.xcframework.zip" --clobber

      - name: CocoaPods push
        if: ${{ inputs.pods == true && inputs.cleanup != true }}
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          set -o pipefail
          pod trunk push --verbose 2>&1 | xcbeautify --renderer github-actions

      - name: CocoaPods lint
        if: ${{ inputs.pods == true && inputs.cleanup == true }}
        run: |
          set -o pipefail
          pod spec lint ${{ vars.PRODUCT_NAME }}.podspec --verbose --allow-warnings 2>&1 | xcbeautify --renderer github-actions

      - name: Cleanup full release (tag + release)
        if: ${{ always() && inputs.is_full_release == true && (inputs.cleanup == true || (failure() && steps.create_tag.outputs.created == 'true')) }}
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          delete_release: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup created release only
        if: ${{ always() && inputs.is_full_release != true && inputs.cleanup == true && inputs.release == true && inputs.release_existed == false }}
        shell: bash
        run: |
          set -euo pipefail
          gh release delete "$RELEASE_TAG" -y || true

      - name: Cleanup temporary tag (dry-run)
        if: ${{ always() && inputs.is_full_release != true && inputs.cleanup == true && inputs.tag == true }}
        shell: bash
        run: |
          set -euo pipefail
          git push origin --delete "$RELEASE_TAG" || true
