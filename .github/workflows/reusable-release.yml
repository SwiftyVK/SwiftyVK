name: _Release

on:
  workflow_call:
    inputs:
      test_mode:
        description: Test mode (draft release + cleanup)
        required: true
        type: boolean
      publish-cocoapods:
        description: Publish to CocoaPods trunk
        required: true
        type: boolean
      publish-carthage:
        description: Build and publish Carthage archive to GitHub release
        required: true
        type: boolean
      release_tag:
        description: Release tag (SemVer X.Y.Z)
        required: true
        type: string
    secrets:
      COCOAPODS_TRUNK_TOKEN:
        required: false

jobs:
  release:
    name: "Release${{ inputs.test_mode && ' (test)' || '' }}"
    runs-on: ${{ vars.MACOS_RUNNER }}
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RELEASE_TAG: ${{ inputs.release_tag }}
    steps:
      - name: Guard branch for real release
        if: ${{ inputs.test_mode != true }}
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_name }}" != "master" ]; then
            echo "::error::Real release allowed only from 'master' (got '${{ github.ref_name }}')"; exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ vars.XCODE_VERSION }}

      - name: Install dependencies
        run: |
          brew install xcbeautify
          gem install cocoapods --no-document
          if [ "${{ inputs['publish-carthage'] }}" = "true" ]; then
            brew install carthage
          fi
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Build Carthage archives
        if: inputs['publish-carthage'] == true
        run: |
          set -o pipefail
          # Build XCFrameworks to avoid lipo conflicts on arm64 simulator/device
          carthage build --no-skip-current --platform iOS,macOS --use-xcframeworks --verbose 2>&1 | xcbeautify --renderer github-actions
          # Package the built XCFramework (fallback to legacy archive if needed)
          PRODUCT_NAME="${{ vars.PRODUCT_NAME }}"
          XCFRAMEWORK_PATH=""
          if [ -d "Carthage/Build/${PRODUCT_NAME}.xcframework" ]; then
            XCFRAMEWORK_PATH="Carthage/Build/${PRODUCT_NAME}.xcframework"
          else
            XCFRAMEWORK_PATH=$(find Carthage/Build -maxdepth 2 -type d -name "${PRODUCT_NAME}.xcframework" | head -n 1 || true)
          fi
          if [ -n "$XCFRAMEWORK_PATH" ] && [ -d "$XCFRAMEWORK_PATH" ]; then
            echo "Found XCFramework at: $XCFRAMEWORK_PATH"
            ARCHIVE_NAME="${PRODUCT_NAME}.xcframework.zip"
            ditto -c -k --sequesterRsrc --keepParent "$XCFRAMEWORK_PATH" "$ARCHIVE_NAME"
            ls -lh "$ARCHIVE_NAME"
          else
            echo "No XCFramework found, falling back to Carthage .framework archive"
            carthage archive "$PRODUCT_NAME"
          fi

      - name: Create tag
        id: create_tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG"
          git push origin "$RELEASE_TAG"
          echo "created=true" >> "$GITHUB_OUTPUT"

      - name: Upload Carthage archive to GitHub Release asset
        if: inputs['publish-carthage'] == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          draft: ${{ inputs.test_mode }}
          files: ${{ vars.PRODUCT_NAME }}.xcframework.zip

      - name: Publish release to CocoaPods
        if: success() && inputs['publish-cocoapods'] == true
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          set -o pipefail
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            pod spec lint ${{ vars.PRODUCT_NAME }}.podspec --verbose --allow-warnings 2>&1 | xcbeautify --renderer github-actions 
          else
            pod trunk push --verbose 2>&1 | xcbeautify --renderer github-actions
          fi

      - name: Cleanup GitHub release and tag
        if: ${{ always() && env.RELEASE_TAG != '' && (inputs.test_mode == true || (failure() && steps.create_tag.outputs.created == 'true')) }}
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          delete_release: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
